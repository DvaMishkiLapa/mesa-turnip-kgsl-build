sudo dpkg --add-architecture armhf
sudo apt update
sudo apt upgrade
sudo apt build-dep mesa 
apt install git wget vulkan-tools mesa-utils g++-arm-linux-gnueabihf g++-aarch64-linux-gnu
apt install libgl1:armhf libvulkan1:armhf libglvnd-dev:armhf zlib1g-dev:armhf libexpat1-dev:armhf libdrm-dev:armhf libx11-dev:armhf libxext-dev:armhf libxdamage-dev:armhf libxcb-glx0-dev:armhf libx11-xcb-dev:armhf libxcb-dri2-0-dev:armhf libxcb-dri3-dev:armhf libxcb-present-dev:armhf libxshmfence-dev:armhf libxxf86vm-dev:armhf libxrandr-dev:armhf libwayland-dev:armhf wayland-protocols:armhf libwayland-egl-backend-dev:armhf libxcb-shm0-dev:armhf pkg-config:armhf
apt install libgl1:arm64 libvulkan1:arm64 libglvnd-dev:arm64 zlib1g-dev:arm64 libexpat1-dev:arm64 libdrm-dev:arm64 libx11-dev:arm64 libxext-dev:arm64 libxdamage-dev:arm64 libxcb-glx0-dev:arm64 libx11-xcb-dev:arm64 libxcb-dri2-0-dev:arm64 libxcb-dri3-dev:arm64 libxcb-present-dev:arm64 libxshmfence-dev:arm64 libxxf86vm-dev:arm64 libxrandr-dev:arm64 libwayland-dev:arm64 wayland-protocols:arm64 libwayland-egl-backend-dev:arm64 libxcb-shm0-dev:arm64 pkg-config:arm64

-----------------------------------------------------------------------------------------------------------------------------------------------------------

cp /usr/include/libdrm/drm.h /usr/include/libdrm/drm_mode.h /usr/include/

wget https://gitlab.freedesktop.org/Danil/mesa/-/archive/freedreno/feature/a610/mesa-freedreno-feature-a610.tar.gz
tar -xf ./*.tar.gz
cd mesa-freedreno-feature-a610


meson build64 --libdir=lib/aarch64-linux-gnu -D platforms=x11,wayland -D gallium-drivers=swrast,virgl,zink,freedreno -D vulkan-drivers=freedreno -D dri3=enabled -D egl=enabled -D gles2=enabled -D glvnd=true -D glx=dri -D libunwind=disabled -D osmesa=true -D shared-glapi=enabled -D microsoft-clc=disabled -D valgrind=disabled --prefix /usr -D gles1=disabled -D freedreno-kmds=kgsl -Dbuildtype=release
ninja -C build64/

meson build32 --cross-file=cross.txt --libdir=lib/arm-linux-gnueabihf -D platforms=x11,wayland -D gallium-drivers=swrast,virgl,zink,freedreno -D vulkan-drivers=freedreno -D dri3=enabled -D egl=enabled -D gles2=enabled -D glvnd=true -D glx=dri -D libunwind=disabled -D osmesa=true -D shared-glapi=enabled -D microsoft-clc=disabled -D valgrind=disabled --prefix /usr -D gles1=disabled -D freedreno-kmds=kgsl -Dbuildtype=release
ninja -C build32/

# warning !! donot run ninja -C build install !!
# instead just copy over turnip driver

cp $(pwd)/build64/src/freedreno/vulkan/libvulkan_freedreno.so /usr/lib/aarch64-linux-gnu/
cp $(pwd)/build32/src/freedreno/vulkan/libvulkan_freedreno.so /usr/lib/arm-linux-gnueabihf/

cp $(pwd)/build64/src/freedreno/vulkan/freedreno_icd.aarch64.json ~/
cp $(pwd)/build32/src/freedreno/vulkan/freedreno_icd.armhf.json ~/

# test turnip 
DISPLAY=:0 TU_DEBUG=noconform MESA_VK_WSI_DEBUG=sw VK_ICD_FILENAMES=~/freedreno_icd.aarch64.json vkcube 

# test zink 
DISPLAY=:0 MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform MESA_VK_WSI_DEBUG=sw VK_ICD_FILENAMES=~/freedreno_icd.aarch64.json glxgears

-----------------------------------------------------------------------------------------------------------------------------------------------------------

nano $(pwd)/cross.txt

[binaries]
c = 'arm-linux-gnueabihf-gcc'
cpp = 'arm-linux-gnueabihf-g++'
ar = 'arm-linux-gnueabihf-ar'
strip = 'arm-linux-gnueabihf-strip'
pkgconfig = 'arm-linux-gnueabihf-pkg-config'

[host_machine]
system = 'linux'
cpu_family = 'arm'
cpu = 'armhf'
endian = 'little'
-----------------------------------------------------------------------------------------------------------------------------------------------------------

meson build64/ --libdir lib/aarch64-linux-gnu/ --prefix $HOME/mesa -D platforms=x11,wayland -D gallium-drivers=swrast,virgl,zink,freedreno -D vulkan-drivers=freedreno -D dri3=enabled -D egl=enabled -D gles2=enabled -D glvnd=true -D glx=dri -D libunwind=disabled -D osmesa=true -D shared-glapi=enabled -D microsoft-clc=disabled -D valgrind=disabled -D gles1=disabled -D freedreno-kmds=kgsl -Dbuildtype=release
meson compile -C build64/

meson build32/ --cross-file cross.txt --libdir lib/arm-linux-gnueabihf/ --prefix $HOME/mesa -D platforms=x11,wayland -D gallium-drivers=swrast,virgl,zink,freedreno -D vulkan-drivers=freedreno -D dri3=enabled -D egl=enabled -D gles2=enabled -D glvnd=true -D glx=dri -D libunwind=disabled -D osmesa=true -D shared-glapi=enabled -D microsoft-clc=disabled -D valgrind=disabled -D gles1=disabled -D freedreno-kmds=kgsl -Dbuildtype=release
meson compile -C build32/

